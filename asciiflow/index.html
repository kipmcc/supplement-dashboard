<!doctype html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>AviFlow</title>
  <link rel="icon" type="image/png" href="aviado-logo.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <style>
    * { font-family: Roboto, sans-serif; }
    html { overscroll-behavior-x: none; }
    body { margin: 0px; overflow: hidden; touch-action: none; }
    /* Hide GitHub link + broken logo from ASCIIFlow toolbar */
    a[href*="github.com/lewish/asciiflow"] { display: none !important; }
    img[src*="github_mark"] { display: none !important; }
    img[src*="logo_min"] { display: none !important; }
    img[src*="logo_full"] { display: none !important; }
    /* Semi-transparent sidebar so grid shows through */
    .MuiPaper-root { background-color: rgba(255,255,255,0.85) !important; backdrop-filter: blur(10px) !important; -webkit-backdrop-filter: blur(10px) !important; }
    .dark .MuiPaper-root { background-color: rgba(40,40,40,0.75) !important; }

    /* Tighten sidebar tool list */
    .MuiListItem-root { padding-top: 4px !important; padding-bottom: 4px !important; min-height: 32px !important; }
    .MuiListItemIcon-root { min-width: 36px !important; }
    .MuiListItemText-root { margin-top: 2px !important; margin-bottom: 2px !important; }

    /* Hide the native ASCIIFlow "<" back caret */
    .MuiPaper-root > div:first-child > svg,
    .MuiPaper-root > button:first-child { display: none !important; }

    /* ===== AviFlow Header (persists always) ===== */
    #aviflow-header {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      transition: width 0.25s ease;
    }
    body.sidebar-open #aviflow-header { width: var(--sidebar-w, 380px); box-sizing: border-box; }
    body.sidebar-collapsed #aviflow-header { width: auto; }
    #aviflow-header .logo {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 15px;
      color: #1f2937;
      text-decoration: none;
    }
    #aviflow-header .logo img { height: 22px; width: 22px; border-radius: 4px; }
    #aviflow-header .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 11px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s;
    }
    #aviflow-header .back-btn:hover { background: #e5e7eb; }
    body.sidebar-collapsed #aviflow-header .back-btn { display: none; }

    /* ===== Sidebar toggle button ===== */
    #sidebar-toggle {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10000;
      width: 24px;
      height: 48px;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid #374151;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: left 0.25s ease, background 0.15s;
      padding: 0;
    }
    #sidebar-toggle:hover { background: #374151; color: #fff; }
    body.sidebar-open #sidebar-toggle { left: var(--sidebar-w, 380px); }
    body.sidebar-collapsed #sidebar-toggle { left: 0px; }

    /* ===== Sidebar collapse ===== */
    body.sidebar-collapsed .MuiPaper-root,
    body.sidebar-collapsed [class*="MuiPaper-root"] {
      transform: translateX(calc(-1 * var(--sidebar-w, 380px) - 40px)) !important;
      transition: transform 0.25s ease !important;
    }
    body.sidebar-open .MuiPaper-root,
    body.sidebar-open [class*="MuiPaper-root"] {
      transition: transform 0.25s ease !important;
    }
  </style>
  <script defer src="asciiflow.bundle.js"></script>
</head>
<body>
  <div id="aviflow-header">
    <span class="logo"><img src="aviado-logo.png" alt=""> AviFlow <span style="font-size:10px;color:#999;font-weight:400">v0.9.2</span></span>
    <a class="back-btn" href="/">← Dashboard</a>
  </div>
  <button id="sidebar-toggle" title="Toggle sidebar">‹</button>
  <div id="root"></div>
  <script src="supabase-bridge.js"></script>
  <script>
    // Sidebar toggle logic
    (function() {
      let sidebarW = 380;

      function detectSidebar() {
        const els = document.querySelectorAll('[class*="MuiPaper"]');
        for (const d of els) {
          if (d.offsetWidth > 200 && d.offsetWidth < 500 && d.offsetHeight > 400) {
            sidebarW = d.offsetWidth;
            document.documentElement.style.setProperty('--sidebar-w', sidebarW + 'px');
            return d;
          }
        }
        return null;
      }

      function hideNativeCaret() {
        // Hide the "<" back caret that ASCIIFlow renders at the top of the sidebar
        const interval = setInterval(() => {
          const sidebar = detectSidebar();
          if (!sidebar) return;
          // Look for clickable elements near the top that act as back navigation
          for (const el of sidebar.querySelectorAll('div, button, a, svg')) {
            const r = el.getBoundingClientRect();
            const t = (el.textContent || '').trim();
            // The caret is near top-left, small, contains "<" or is an SVG arrow
            if (r.top < 80 && r.height < 50 && r.width < 80 &&
                (t === '<' || t === '‹' || el.tagName === 'svg' || (el.tagName === 'path'))) {
              // Only hide if it looks like the native back button, not our toggle
              if (el.id !== 'sidebar-toggle' && !el.closest('#aviflow-header') && !el.closest('#af-cloud')) {
                el.style.display = 'none';
              }
            }
          }
          clearInterval(interval);
        }, 500);
        setTimeout(() => clearInterval(interval), 5000);
      }

      function initToggle() {
        const btn = document.getElementById('sidebar-toggle');
        if (!btn) return;
        document.body.classList.add('sidebar-open');
        document.documentElement.style.setProperty('--sidebar-w', sidebarW + 'px');
        btn.style.left = sidebarW + 'px';

        hideNativeCaret();

        btn.addEventListener('click', () => {
          const canvas = window.__aviflow_store?.currentCanvas;
          // Save offset before toggle
          const savedOffset = canvas ? { x: canvas.offset.x, y: canvas.offset.y } : null;
          const savedZoom = canvas ? canvas.zoom : null;

          const collapsed = document.body.classList.toggle('sidebar-collapsed');
          document.body.classList.toggle('sidebar-open', !collapsed);
          btn.textContent = collapsed ? '›' : '‹';
          btn.style.left = collapsed ? '0px' : sidebarW + 'px';

          // Restore offset after toggle to keep diagram centered
          const restore = () => {
            if (canvas && savedOffset) {
              canvas.setOffset(savedOffset);
              if (savedZoom) canvas.setZoom(savedZoom);
            }
          };
          setTimeout(restore, 50);
          setTimeout(restore, 300);
          // Force canvas redraw after CSS transition completes
          setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initToggle);
      } else {
        setTimeout(initToggle, 100);
      }
    })();
  </script>
</body>
</html>
